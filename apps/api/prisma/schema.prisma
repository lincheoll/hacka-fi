generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model UserProfile {
  walletAddress String @id @map("wallet_address")
  username      String? @unique
  bio           String?
  avatarUrl     String? @map("avatar_url")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  createdHackathons Hackathon[] @relation("HackathonCreator")
  participations    Participant[]
  votes            Vote[]
  achievements     UserAchievement[]
  auditLogs        AuditLog[]
  judgeRoles       HackathonJudge[] @relation("JudgeRole")
  addedJudges      HackathonJudge[] @relation("JudgeAdder")

  @@map("user_profiles")
}

model Hackathon {
  id                    String   @id @default(cuid())
  title                String
  description          String
  organizerAddress     String   @map("organizer_address")
  registrationDeadline DateTime @map("registration_deadline")
  submissionDeadline   DateTime @map("submission_deadline")
  votingDeadline       DateTime @map("voting_deadline")
  status               HackathonStatus @default(DRAFT)
  prizeAmount          String?  @map("prize_amount") // Using String for BigInt compatibility
  entryFee             String?  @map("entry_fee") // Using String for BigInt compatibility
  maxParticipants      Int?     @map("max_participants")
  coverImageUrl        String?  @map("cover_image_url")
  contractAddress      String?  @map("contract_address")
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  organizer      UserProfile     @relation("HackathonCreator", fields: [organizerAddress], references: [walletAddress])
  participants   Participant[]
  votes          Vote[]
  results        Result[]
  achievements   UserAchievement[]
  auditLogs      AuditLog[]
  judges         HackathonJudge[]
  prizePool      PrizePool?

  @@map("hackathons")
}

model Participant {
  id             Int      @id @default(autoincrement())
  hackathonId    String   @map("hackathon_id")
  walletAddress  String   @map("wallet_address")
  submissionUrl  String?  @map("submission_url")
  entryFee       String?  @map("entry_fee") // Using String for BigInt compatibility
  rank           Int?
  prizeAmount    String?  @map("prize_amount") // Using String for BigInt compatibility
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  hackathon Hackathon   @relation(fields: [hackathonId], references: [id], onDelete: Cascade)
  user      UserProfile @relation(fields: [walletAddress], references: [walletAddress])
  votes     Vote[]

  @@unique([hackathonId, walletAddress])
  @@map("participants")
}

model Vote {
  id            Int      @id @default(autoincrement())
  hackathonId   String   @map("hackathon_id")
  judgeAddress  String   @map("judge_address")
  participantId Int      @map("participant_id")
  score         Int
  comment       String?  // Optional comment from judge
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  hackathon   Hackathon   @relation(fields: [hackathonId], references: [id], onDelete: Cascade)
  judge       UserProfile @relation(fields: [judgeAddress], references: [walletAddress])
  participant Participant @relation(fields: [participantId], references: [id], onDelete: Cascade)

  @@unique([hackathonId, judgeAddress, participantId])
  @@map("votes")
}

model HackathonJudge {
  id           Int      @id @default(autoincrement())
  hackathonId  String   @map("hackathon_id")
  judgeAddress String   @map("judge_address")
  addedBy      String   @map("added_by")
  addedAt      DateTime @default(now()) @map("added_at")

  hackathon Hackathon   @relation(fields: [hackathonId], references: [id], onDelete: Cascade)
  judge     UserProfile @relation("JudgeRole", fields: [judgeAddress], references: [walletAddress])
  addedByUser UserProfile @relation("JudgeAdder", fields: [addedBy], references: [walletAddress])

  @@unique([hackathonId, judgeAddress])
  @@map("hackathon_judges")
}

model Result {
  id                  Int      @id @default(autoincrement())
  hackathonId         String   @unique @map("hackathon_id")
  winners             String   // JSON string of winner data
  totalPrizePool      String   @map("total_prize_pool") // Using String for BigInt compatibility
  distributionTxHash  String?  @map("distribution_tx_hash")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  hackathon Hackathon @relation(fields: [hackathonId], references: [id], onDelete: Cascade)

  @@map("results")
}

model UserAchievement {
  id           Int                 @id @default(autoincrement())
  userAddress  String              @map("user_address")
  achievementType AchievementType  @map("achievement_type")
  hackathonId  String?             @map("hackathon_id")
  rank         Int?
  prizeAmount  String?             @map("prize_amount") // Using String for BigInt compatibility
  earnedAt     DateTime            @default(now()) @map("earned_at")

  user      UserProfile @relation(fields: [userAddress], references: [walletAddress])
  hackathon Hackathon?  @relation(fields: [hackathonId], references: [id])

  @@map("user_achievements")
}

model AuditLog {
  id            String         @id @default(cuid())
  hackathonId   String         @map("hackathon_id")
  action        AuditAction
  fromStatus    HackathonStatus? @map("from_status")
  toStatus      HackathonStatus  @map("to_status")
  reason        String
  triggeredBy   TriggerType    @map("triggered_by")
  userAddress   String?        @map("user_address")
  metadata      Json?        // JSON for additional data
  ipAddress     String?        @map("ip_address")
  userAgent     String?        @map("user_agent")
  timestamp     DateTime       @default(now()) // Add timestamp field for frontend compatibility
  createdAt     DateTime       @default(now()) @map("created_at")

  hackathon Hackathon @relation(fields: [hackathonId], references: [id], onDelete: Cascade)
  user      UserProfile? @relation(fields: [userAddress], references: [walletAddress])

  @@index([hackathonId])
  @@index([timestamp])
  @@index([action])
  @@index([triggeredBy])
  @@map("audit_logs")
}

model PrizePool {
  id                    Int      @id @default(autoincrement())
  hackathonId           String   @unique @map("hackathon_id")
  totalAmount           String   @map("total_amount") // Using String for BigInt compatibility
  contractPoolId        String?  @map("contract_pool_id") // Smart contract pool ID
  contractAddress       String?  @map("contract_address") // Prize pool contract address
  isDeposited           Boolean  @default(false) @map("is_deposited")
  depositTxHash         String?  @map("deposit_tx_hash")
  isDistributed         Boolean  @default(false) @map("is_distributed")
  distributionTxHash    String?  @map("distribution_tx_hash")
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  hackathon             Hackathon @relation(fields: [hackathonId], references: [id], onDelete: Cascade)
  deposits              PrizePoolDeposit[]
  distributions         PrizeDistribution[]
  distributionTransactions DistributionTransaction[]

  @@map("prize_pools")
}

model PrizePoolDeposit {
  id                    Int      @id @default(autoincrement())
  prizePoolId           Int      @map("prize_pool_id")
  depositorAddress      String   @map("depositor_address")
  amount                String   // Using String for BigInt compatibility
  txHash                String   @map("tx_hash")
  blockNumber           Int?     @map("block_number")
  status                DepositStatus @default(PENDING)
  createdAt             DateTime @default(now()) @map("created_at")
  confirmedAt           DateTime? @map("confirmed_at")

  prizePool             PrizePool @relation(fields: [prizePoolId], references: [id], onDelete: Cascade)

  @@index([prizePoolId])
  @@index([status])
  @@index([txHash])
  @@map("prize_pool_deposits")
}

model PrizeDistribution {
  id                    Int      @id @default(autoincrement())
  prizePoolId           Int      @map("prize_pool_id")
  hackathonId           String   @map("hackathon_id")
  recipientAddress      String   @map("recipient_address")
  position              Int      // 1st, 2nd, 3rd place
  amount                String   // Using String for BigInt compatibility
  percentage            Int      // Percentage in basis points (e.g., 6000 = 60%)
  txHash                String?  @map("tx_hash")
  blockNumber           Int?     @map("block_number")
  status                DistributionStatus @default(PENDING)
  executedAt            DateTime? @map("executed_at")
  createdAt             DateTime @default(now()) @map("created_at")
  error                 String?

  prizePool             PrizePool @relation(fields: [prizePoolId], references: [id], onDelete: Cascade)

  @@index([prizePoolId])
  @@index([hackathonId])
  @@index([status])
  @@index([txHash])
  @@map("prize_distributions")
}

model DistributionTransaction {
  id                    Int      @id @default(autoincrement())
  hackathonId           String   @map("hackathon_id")
  prizePoolId           Int      @map("prize_pool_id")
  txHash                String   @unique @map("tx_hash")
  status                DistributionStatus @default(PENDING)
  submittedAt           DateTime @map("submitted_at")
  confirmedAt           DateTime? @map("confirmed_at")
  failedAt              DateTime? @map("failed_at")
  retryCount            Int      @default(0) @map("retry_count")
  gasPrice              String?  @map("gas_price")
  gasLimit              String?  @map("gas_limit")
  gasUsed               String?  @map("gas_used")
  blockNumber           String?  @map("block_number")
  error                 String?
  recipients            Json     // Array of recipient addresses
  amounts               Json     // Array of amounts
  totalAmount           String   @map("total_amount")
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  prizePool             PrizePool @relation(fields: [prizePoolId], references: [id], onDelete: Cascade)

  @@index([hackathonId])
  @@index([status])
  @@index([submittedAt])
  @@map("distribution_transactions")
}

enum DepositStatus {
  PENDING
  CONFIRMED
  FAILED
}

enum DistributionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

enum AuditAction {
  STATUS_CHANGE
  MANUAL_OVERRIDE
  AUTOMATIC_TRANSITION
}

enum TriggerType {
  SYSTEM
  ORGANIZER
  ADMIN
}

enum HackathonStatus {
  DRAFT
  REGISTRATION_OPEN
  REGISTRATION_CLOSED
  SUBMISSION_OPEN
  SUBMISSION_CLOSED
  VOTING_OPEN
  VOTING_CLOSED
  COMPLETED
}

enum AchievementType {
  WINNER
  RUNNER_UP
  PARTICIPANT
  JUDGE
  CREATOR
}

